<div class="container">
  <ol class="breadcrumb">
    <%= render_breadcrumbs :tag => :li, :separator => " > " %>
  </ol>
  <div class="row">
    <div class="col-12 col-md-8">
      <% if flash[:error] %>
        <div class="row">
          <div class="col-sm-12 col-md-6 offset-md-3 error-message">
            <i class="fa fa-exclamation-circle"></i><%= flash[:error] %>
          </div>
        </div>
      <% end %>
      <div class="row">
        <div class="col-12 col-lg-7">
          <table class="table table-bordered table-title">
            <thead>
              <tr>
                <th>
                  <% @participants.each do |participant| %>
                    <% if participant.user_id == current_user.id %>
                      <%= link_to users_request_room_path(request, @room) do %>
                        <i class="fa fa-comments fa-lg" style="color: blue; float: left;"></i>
                      <% end %>
                    <% end %>
                  <% end %>
                  <% if @request.user == current_user %>
                    <%= link_to users_request_room_path(request, @room) do %>
                      <i class="fa fa-comments fa-lg" style="color: blue; float: left;"></i>
                    <% end %>
                    <% if DateTime.now < @request.datetime %>
                      <div style="float: right;">
                        <%= link_to edit_users_request_path do %>
                          <i class="fa fa-edit fa-lg" style="color: green;"></i>
                        <% end %>
                        <%= link_to users_request_path, method: :delete, data: { confirm: "<i class='fa fa-exclamation-circle'></i>本当に依頼を削除しますか？",
                                                           cancel: "戻る",
                                                           commit: '削除する' } do %>
                          <i class="fa fa-trash fa-lg" style="color: red;"></i>
                        <% end %>
                      </div>
                    <% end %>
                  <% end %>
                </th>
              </tr>
            </thead>
          </table>
          <table class="table table-bordered table-striped">
            <tbody>
              <tr>
                <th>タイトル</th>
                <td><%= @request.title %></td>
              </tr>
              <tr>
                <th>詳細</th>
                <td><%= safe_join(@request.content.split("\n"),tag(:br)) %></td>
              </tr>
              <tr>
                <th>依頼者</th>
                <td><%= link_to @request.user.name, users_user_path(@request.user), class: "link" %></td>
              </tr>
              <tr>
                <th>日程</th>
                <td><%= @request.datetime %></td>
              </tr>
              <tr>
                <th>住所</th>
                <td>
                  <p><%= @request.address %></p>
                </td>
              </tr>
              <tr>
                <th></th>
                <td>
                  <div id="map"></div>
                </td>
              </tr>
              <tr>
                <th>募集人数</th>
                <td><%= @request.capacity %></td>
              </tr>
              <tr>
                <th>募集締切</th>
                <td><%= @request.deadline %></td>
              </tr>
              <tr>
                <th>サムネ画像</th>
                <td><%= attachment_image_tag @request, :image, :fill, 150, 100, format: 'jpg', fallback: "1560031.jpg", class: "ggg" %></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="col-12 col-lg-5">
          <table class="table table-bordered table-title">
            <thead>
              <tr>
                <th>助っ人一覧</th>
              </tr>
            </thead>
          </table>
          <% if @request.participants.exists? == false %>
            <table class="table table-bordered">
              <tbody>
                <tr>
                  <td>助っ人はいません</td>
                </tr>
              </tbody>
            </table>
          <% end %>
          <table class="table table-bordered">
            <% @num = 1 %>
            <tbody>
              <% @participants.each do |participant| %>
                <tr>
                  <th><%= @num %></th>
                  <td><%= link_to participant.user.name, users_user_path(participant.user), class: "link" %> さん</td>
                </tr>
                <% @num = @num + 1 %>
              <% end %>
            </tbody>
          </table>
          <% if DateTime.now >= @request.datetime %>
            <p>この依頼は終了しました</p>
          <% else %>
            <% if @request.user.id != current_user.id %>
              <% if @request.participants.exists?(user_id: current_user.id) %>
                <%= link_to "キャンセルする", users_request_participant_path(@request, @participant), method: :delete, class: "btn btn-danger", data: { confirm: "<i class='fa fa-exclamation-circle'></i>本当に助っ人登録をキャンセルしますか？",
                                                               cancel: "戻る",
                                                               commit: "キャンセルする" } %>
              <% else %>
                <% if @request.capacity > @request.participants.count %>
                  <% if DateTime.now < @request.deadline %>
                    <%= link_to "助っ人になる", users_request_participants_path(@request), method: :post, class: "btn btn-info", data: { confirm: "<i class='fa fa-exclamation-circle'></i>本当に助っ人登録しますか？",
                                                           cancel: "戻る",
                                                           commit: "登録する" } %>
                  <% else %>
                    <p>募集を締め切りました</p>
                  <% end %>
                <% else %>
                  <p>定員に達しました</p>
                <% end %>
              <% end %>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
    <%= render 'layouts/profile', user: current_user %>
  </div>

</div>

<script type="text/javascript">
  function initMap() {
    var test ={lat: <%= @request.latitude %>, lng: <%= @request.longitude %>};
    var map = new google.maps.Map(document.getElementById('map'), {
              zoom: 15,
              center: test
              });
    var transitLayer = new google.maps.TransitLayer();
    transitLayer.setMap(map);

    var contentString = '住所：<%= @request.address %>';
    var infowindow = new google.maps.InfoWindow({
      content: contentString
    });
    var marker = new google.maps.Marker({
                  position:test,
                  map: map,
                  title: contentString
                 });

     marker.addListener('click', function() {
       infowindow.open(map, marker);
     });
  }
</script>
<script async defer
              src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=<%= ENV['GOOGLE_MAP_API_KEY'] %>&callback=initMap">
</script>
<style type="text/css">
  #map { height: 200px;
         width: 100%;}
</style>