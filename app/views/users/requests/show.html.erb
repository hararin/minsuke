<ol class="breadcrumb">
    <%= render_breadcrumbs :tag => :li, :separator => " > " %>
  </ol>
<div class="container">
  <div class="row">
    <div class="col-12 col-md-8 form-box">
      <% if flash[:error] %>
        <div class="row">
          <div class="col-sm-12 col-md-6 offset-md-3 error-message">
            <i class="fa fa-exclamation-circle"></i><%= flash[:error] %>
          </div>
        </div>
      <% end %>
      <div class="row request-info">
        <div class="col-12">
          <h2><strong><%= @request.title %></strong></h2>
          <p class="request-content"><%= safe_join(@request.content.split("\n"),tag(:br)) %></p>
        </div>
        <div class="col-12">
          <p><%= attachment_image_tag @request, :image, :fill, 100, 100, format: 'jpg', fallback: "1560031.jpg", size: '100x100', class: "request-img" %></p>
        </div>
        <div class="col-12">
          <h4>依頼者</h4>
          <p><%= link_to @request.user.name, users_user_path(@request.user) %></p>
        </div>
        <div class="col-12">
          <h4>日程</h4>
          <p><%= @request.datetime %></p>
        </div>
        <div class="col-12">
          <h4>住所</h4>
          <p><%= @request.address %></p>
          <p id="map"></p>
        </div>
        <div class="col-12">
          <h4>募集人数</h4>
          <p><%= @request.capacity %>名</p>
        </div>
        <div class="col-12">
          <h4>募集締切日時</h4>
          <p><%= @request.deadline %></p>
        </div>
        <div class="col-12">
          <h4>助っ人一覧</h4>
          <% @participants.each do |participant| %>
            <p><%= link_to participant.user.name, users_user_path(participant.user) %></p>
          <% end %>
        </div>
      </div>
      <div class="row options">
        <div class="col-12">
          <% if DateTime.now >= @request.datetime %>
            <p>この依頼は終了しました</p>
          <% else %>
            <% if @request.user.id != current_user.id %>
              <% if @request.participants.exists?(user_id: current_user.id) %>
                <%= link_to "キャンセルする", users_request_participant_path(@request, @participant), method: :delete, class: "btn btn-danger", data: { confirm: "<i class='fa fa-exclamation-circle'></i>本当に助っ人登録をキャンセルしますか？", cancel: "戻る", commit: "キャンセルする" } %>
                <%= link_to users_request_room_path(@request, @room) do %>
                  <button class="btn btn-info">チャット <i class="fa fa-comments fa-lg"></i></button>
                <% end %>
              <% else %>
                <% if @request.capacity > @request.participants.count %>
                  <% if DateTime.now < @request.deadline %>
                    <%= link_to "助っ人になる", users_request_participants_path(@request), method: :post, class: "btn btn-info", data: { confirm: "<i class='fa fa-exclamation-circle'></i>本当に助っ人登録しますか？",
                                                           cancel: "戻る",
                                                           commit: "登録する" } %>
                  <% else %>
                    <p>募集を締め切りました</p>
                  <% end %>
                <% else %>
                  <p>定員に達しました</p>
                <% end %>
              <% end %>
            <% else %>
              <%= link_to users_request_room_path(request, @room) do %>
                <button class="btn btn-info">チャット <i class="fa fa-comments fa-lg"></i></button>
              <% end %>
              <% if DateTime.now < @request.datetime %>
                <%= link_to edit_users_request_path do %>
                  <button class="btn btn-success">編集する <i class="fa fa-edit fa-lg"></i></button>
                <% end %>
                <%= link_to users_request_path, method: :delete, data: { confirm: "<i class='fa fa-exclamation-circle'></i>本当に依頼を削除しますか？",cancel: "戻る", commit: '削除する' } do %>
                  <button class="btn btn-danger">削除する <i class="fa fa-trash fa-lg"></i></button>
                <% end %>
              <% end %>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
    <%= render 'layouts/profile', user: current_user, requests: @progress_requests, participants: @progress_participants %>
  </div>
</div>

<script type="text/javascript">
  function initMap() {
    var test ={lat: <%= @request.latitude %>, lng: <%= @request.longitude %>};
    var map = new google.maps.Map(document.getElementById('map'), {
              zoom: 15,
              center: test
              });
    var transitLayer = new google.maps.TransitLayer();
    transitLayer.setMap(map);

    var contentString = '住所：<%= @request.address %>';
    var infowindow = new google.maps.InfoWindow({
      content: contentString
    });
    var marker = new google.maps.Marker({
                  position:test,
                  map: map,
                  title: contentString
                 });

     marker.addListener('click', function() {
       infowindow.open(map, marker);
     });
  }
</script>
<script async defer
              src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=<%= ENV['GOOGLE_MAP_API_KEY'] %>&callback=initMap">
</script>
<style type="text/css">
  #map { height: 200px;
         width: 100%;}
</style>